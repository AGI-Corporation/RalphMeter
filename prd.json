{
  "project": "RalphMeter",
  "branchName": "ralph/initial-build",
  "description": "A metering, transparency, and benchmarking layer for AI coding agents. Measures energy efficiency in Verified LOC per unit cost, providing the physical unit for AI code synthesis.",
  "userStories": [
    {
      "id": "US-000",
      "title": "Architecture Foundation",
      "description": "Establish project structure, shared types, and code quality tooling before any feature development.",
      "acceptanceCriteria": [
        "Create src/types/index.ts as centralized type exports barrel",
        "Create src/schemas/index.ts for shared Zod schemas (re-exported from feature modules)",
        "Configure ESLint with @typescript-eslint, strict rules, no-unused-vars error",
        "Configure Prettier with consistent style (semi: true, singleQuote: true, trailingComma: 'es5')",
        "tsconfig.json strict mode enabled (strict: true, noUncheckedIndexedAccess: true)",
        "All modules use barrel exports (index.ts) for public API",
        "Create src/shared/result.ts with Result<T, E> type for error handling pattern",
        "Add .editorconfig for consistent formatting across editors",
        "npm run lint and npm run format scripts in package.json",
        "Typecheck passes with zero errors",
        "Lint passes with zero errors",
        "Latest dependencies installed",
        "No vulnerabilities in npm audit",
        "Create an instructions MD file to make sure future contributors understand the architecture and coding standards established."
      ],
      "priority": 0,
      "passes": true,
      "notes": "Foundation story - must complete before all others. Sets patterns that all subsequent code follows."
    },
    {
      "id": "US-001",
      "title": "Metering Core - Event Schema",
      "description": "Define the core event schema for capturing agent activity using Zod validation.",
      "acceptanceCriteria": [
        "Create src/core/events.ts with Zod schemas for: session_start, session_end, iteration_start, iteration_end, tokens_in, tokens_out, compilation_result, test_result, story_complete",
        "Each event has timestamp (ISO string), sessionId (UUID), eventType, and type-specific payload",
        "session_start includes optional tags field: Record<string, string> for arbitrary metadata (mode, methodology, A/B tests, etc.)",
        "iteration_start and iteration_end include storyId field to track which story the iteration targets",
        "Export validateEvent() and safeValidateEvent() functions",
        "Export TypeScript types for all event types",
        "Typecheck passes",
        "Tests pass in src/core/events.test.ts"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation for all metering. Events are the raw signal."
    },
    {
      "id": "US-002",
      "title": "Metering Core - Event Collector",
      "description": "Create EventCollector class that receives, validates, and stores events in memory.",
      "acceptanceCriteria": [
        "Create src/core/collector.ts with EventCollector class",
        "Methods: emit(event), getSession(id), getAllSessions(), getMetrics(sessionId)",
        "Auto-create session on session_start event",
        "Update session status on session_end event",
        "Calculate basic metrics: totalIterations, totalTokensIn, totalTokensOut, compilationAttempts/Successes, testAttempts/Successes",
        "Typecheck passes",
        "Tests pass in src/core/collector.test.ts"
      ],
      "priority": 2,
      "passes": false,
      "notes": "In-memory first, SQLite persistence can come later."
    },
    {
      "id": "US-003",
      "title": "Metering Core - LOC Counter",
      "description": "Create LOC counter that analyzes code files and categorizes lines.",
      "acceptanceCriteria": [
        "Create src/core/loc.ts with LOCCounter class",
        "Methods: detectLanguage(filePath), countLines(content, language), countFile(path, content), aggregate(results[]), snapshotCodebase(rootPath)",
        "snapshotCodebase counts all LOC in codebase at a point in time (for cumulative Synth calculation)",
        "Support TypeScript, JavaScript, Python comment styles",
        "Return { total, code, comments, blank } breakdown",
        "Typecheck passes",
        "Tests pass in src/core/loc.test.ts"
      ],
      "priority": 3,
      "passes": false,
      "notes": "LOC is measured as codebase snapshot, not deltas. Synth = cumulative_tokens / current_LOC."
    },
    {
      "id": "US-004",
      "title": "Metering Core - Gate Tracker",
      "description": "Implement the 3-gate verification model tracker with line-level granularity.",
      "acceptanceCriteria": [
        "Create src/core/gates.ts with GateTracker class",
        "Define Gate type: G1_COMPILE, G2_CORRECT, G3_REACHABLE",
        "Each gate tracks verification at line-level: G1 via compiler errors, G2 via test coverage, G3 via runtime coverage",
        "Methods: record(sessionId, result), getResults(sessionId), getGateStats(sessionId, gate), getSessionStats(sessionId), getLineVerification(sessionId, filePath)",
        "Support configurable thresholds per gate: { required: boolean, threshold: number (0-1), skip: boolean }",
        "Calculate per-gate: linesChecked, linesPassed, passRate, poe (probability of error)",
        "A line is verified only if it passes ALL applicable gates",
        "Calculate overallPoE using: 1 - ∏(1 - PoE_i)",
        "Typecheck passes",
        "Tests pass in src/core/gates.test.ts"
      ],
      "priority": 4,
      "passes": false,
      "notes": "3-gate model with line-level verification. G1=compile errors, G2=test coverage, G3=runtime coverage."
    },
    {
      "id": "US-005",
      "title": "Metrics Calculator",
      "description": "Create MetricsCalculator that computes the headline efficiency metrics.",
      "acceptanceCriteria": [
        "Create src/core/metrics.ts with MetricsCalculator class",
        "Constructor takes EventCollector, GateTracker, LOCCounter",
        "calculate() returns: verifiedLOC, totalLOC, verificationRate (vLOC/LOC), locPerMinute (LOC/M), vlocPerMinute (vLOC/M), tokensPerLOC (Synth), poeLOC, totalMinutes",
        "PoE-LOC = total errors / total LOC",
        "Synth = Cumulative Tokens / Current LOC (snapshot-based, recalculated after each story)",
        "Track Synth trend over time — spikes indicate problem stories",
        "Verification Rate = vLOC / LOC",
        "formatReport() returns human-readable metrics report string",
        "Typecheck passes",
        "Tests pass in src/core/metrics.test.ts"
      ],
      "priority": 5,
      "passes": false,
      "notes": "This is where the physical unit emerges: Verified LOC / Energy"
    },
    {
      "id": "US-006",
      "title": "REST API - Core Endpoints",
      "description": "Create Express REST API for metering data.",
      "acceptanceCriteria": [
        "Create src/api/server.ts with Express app",
        "POST /api/sessions - create new session (returns sessionId)",
        "POST /api/sessions/:id/events - emit event to session",
        "GET /api/sessions - list all sessions",
        "GET /api/sessions/:id - get session details",
        "GET /api/sessions/:id/metrics - get calculated metrics",
        "Request validation using Zod",
        "Error handling middleware with proper status codes",
        "Typecheck passes",
        "Tests pass using supertest"
      ],
      "priority": 6,
      "passes": false,
      "notes": "API enables external tools to send events and read metrics."
    },
    {
      "id": "US-007",
      "title": "Ralph Integration - Hook System",
      "description": "Create hook system that can be injected into Ralph's loop.",
      "acceptanceCriteria": [
        "Create src/integrations/ralph-hooks.ts",
        "Export createRalphHooks(meterUrl) factory function",
        "Hooks for: onSessionStart, onIterationStart, onIterationEnd, onCompilation, onTestRun, onStoryComplete, onSessionEnd",
        "Each hook sends appropriate event to RalphMeter API",
        "Include example ralph.sh modifications in README",
        "Typecheck passes",
        "Include integration test with mock server"
      ],
      "priority": 7,
      "passes": false,
      "notes": "This is how Ralph feeds data into the meter."
    },
    {
      "id": "US-008",
      "title": "CLI Tool - Basic Commands",
      "description": "Create CLI for starting server and viewing metrics.",
      "acceptanceCriteria": [
        "Create src/cli/index.ts as CLI entry point",
        "Use commander.js for argument parsing",
        "Command: ralphmeter start [--port 3333] - launch the API server",
        "Command: ralphmeter status - show running sessions summary",
        "Command: ralphmeter report <sessionId> - print full metrics report",
        "Add bin entry to package.json",
        "Typecheck passes",
        "CLI --help works for all commands"
      ],
      "priority": 8,
      "passes": false,
      "notes": "CLI is the primary interface for local use."
    },
    {
      "id": "US-009",
      "title": "Benchmark Suite - Reference PRDs",
      "description": "Create reference PRDs with known complexity for calibration.",
      "acceptanceCriteria": [
        "Create src/benchmarks/references/ directory",
        "Create 3 reference PRDs in Ralph prd.json format: hello-api.json (~50 LOC, trivial), todo-crud.json (~200 LOC, medium), auth-flow.json (~500 LOC, complex)",
        "Each PRD includes metadata: expectedLOC (range), complexityScore (1-10), expectedIterations (range)",
        "Create src/benchmarks/types.ts with Benchmark interface",
        "Create src/benchmarks/loader.ts to load and validate benchmark PRDs",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Benchmarks provide calibration points for efficiency comparisons."
    },
    {
      "id": "US-010",
      "title": "Benchmark Suite - Comparison Engine",
      "description": "Create engine to compare session metrics against benchmarks.",
      "acceptanceCriteria": [
        "Create src/benchmarks/comparison.ts with BenchmarkComparison class",
        "compare(sessionId, benchmarkId) method",
        "Calculate efficiency ratio: actual efficiency / expected efficiency",
        "Generate report with: benchmark name, expected vs actual LOC, expected vs actual iterations, efficiency score, pass/fail, recommendations",
        "Typecheck passes",
        "Tests pass with mock data"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Comparison gives meaning to raw metrics via calibration."
    },
    {
      "id": "US-011",
      "title": "Export - Open Metrics Format",
      "description": "Create standardized export format for metrics interchange.",
      "acceptanceCriteria": [
        "Create src/export/format.ts with RalphMeterExport interface",
        "Format includes: version (v1), sessionMetadata, allEvents, computedMetrics, gateHistory, locBreakdown",
        "Create src/export/exporter.ts with exportSession(sessionId) function",
        "Add GET /api/sessions/:id/export endpoint",
        "Include JSON schema file at src/export/schema.json",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Open format enables ecosystem tooling and comparisons."
    },
    {
      "id": "US-012",
      "title": "AI Explorer - Coverage Instrumentation",
      "description": "Create instrumented app runner that captures runtime coverage during AI exploration.",
      "acceptanceCriteria": [
        "Create src/explorer/coverage.ts with CoverageCollector class",
        "Method: startInstrumented(appCommand, options) - starts app with V8/c8 coverage",
        "Method: stopAndCollect() - returns per-line coverage data",
        "Support Node.js apps with c8 instrumentation",
        "Return { executed: Line[], notExecuted: Line[] } with file paths and line numbers",
        "Typecheck passes",
        "Tests pass with sample app"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Foundation for G3 reachability via actual runtime execution."
    },
    {
      "id": "US-013",
      "title": "AI Explorer - Surface Explorer",
      "description": "Create AI-driven exploration that exercises all app surfaces.",
      "acceptanceCriteria": [
        "Create src/explorer/surface.ts with SurfaceExplorer class",
        "Integration with Playwright for browser automation",
        "Method: explore(baseUrl, options) - AI explores all visible UI surfaces",
        "Clicks buttons, fills forms, navigates links, triggers interactions",
        "Records HTTP responses including status codes",
        "Returns exploration log with: urls visited, actions taken, responses received",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "AI explores every surface to prove reachability, not just test paths."
    },
    {
      "id": "US-014",
      "title": "AI Explorer - Auth Barrier Detection",
      "description": "Track authentication and authorization barriers during exploration.",
      "acceptanceCriteria": [
        "Create src/explorer/barriers.ts with BarrierTracker class",
        "Detect and categorize: 401 (unauthenticated), 403 (forbidden), 402 (payment required)",
        "Track which URLs/paths are blocked by each barrier type",
        "Infer which code paths are behind auth barriers",
        "Return { authGated: Line[], permissionGated: Line[], paywallGated: Line[] }",
        "Do NOT flag auth-gated code as dead/unreachable",
        "Typecheck passes",
        "Tests pass with mock 401/403 responses"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Prevents false positives - code behind auth is not dead code."
    },
    {
      "id": "US-015",
      "title": "AI Explorer - Exploration Modes",
      "description": "Support different auth levels for comprehensive exploration.",
      "acceptanceCriteria": [
        "Add exploration modes: anonymous, authenticated, privileged, full",
        "Anonymous: no credentials, tracks all auth barriers",
        "Authenticated: uses provided user credentials",
        "Privileged: uses provided admin credentials",
        "Full: runs all modes sequentially, merges coverage",
        "Credentials passed via config or environment variables",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Different modes unlock different code paths for verification."
    },
    {
      "id": "US-016",
      "title": "G3 Reachability Report",
      "description": "Generate comprehensive reachability report from AI exploration.",
      "acceptanceCriteria": [
        "Create src/explorer/report.ts with ReachabilityReport class",
        "Combine coverage data + barrier detection into unified report",
        "Categories: exercised (G3 pass), authGated (unknown), permissionGated (unknown), unreached (G3 fail)",
        "Calculate percentages for each category",
        "Generate actionable recommendations: 'Provide auth to verify X more LOC'",
        "Add GET /api/sessions/:id/reachability endpoint",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "The honest G3 report - not just pass/fail, but WHY."
    },
    {
      "id": "US-017",
      "title": "Documentation - Complete README",
      "description": "Write comprehensive documentation.",
      "acceptanceCriteria": [
        "Update README.md with: project vision (physical energy concept), the 3-gate model explanation, quick start guide, API reference, CLI reference, Ralph integration guide, metric definitions (PoE-LOC, Verified LOC, Synth), AI Explorer guide, contributing guide for benchmark PRDs",
        "Include architecture diagram reference to image.png",
        "Add CONTRIBUTING.md with benchmark PRD submission guidelines",
        "Typecheck passes (for any code examples)"
      ],
      "priority": 17,
      "passes": false,
      "notes": "Documentation makes the project usable and the concepts clear."
    },
    {
      "id": "US-018",
      "title": "Pluggable Quality Gates",
      "description": "Create a plugin architecture for custom quality gates beyond the core G1-G3.",
      "acceptanceCriteria": [
        "Create src/core/gate-plugin.ts with Gate interface: id, name, category (core|quality), appliesWhen(), check()",
        "GateResult type with: pass (boolean), score (optional 0-100), findings (optional array)",
        "Create src/core/gate-registry.ts with GateRegistry class",
        "Methods: register(gate), unregister(id), getApplicable(projectMeta), runAll(artifact)",
        "Support verification modes: 'core' (G1-G3 only), 'strict' (core + all quality), 'custom' (user-selected)",
        "Create src/gates/ directory for built-in quality gate plugins",
        "Create src/gates/complexity.ts - cyclomatic complexity check using eslint",
        "Create src/gates/coverage.ts - test coverage threshold check",
        "Create src/gates/security.ts - SAST integration (semgrep/snyk stub)",
        "Configuration via ralphmeter.config.yaml or API",
        "Update MetricsCalculator to report vLOC per verification mode",
        "Typecheck passes",
        "Tests pass in src/core/gate-plugin.test.ts"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Quality gates are optional but enable stricter verification. vLOC meaning depends on which gates you require."
    }
  ]
}
